/**
 * @param {object} req - the request object
 * @returns {string} - the client user as string
 * @private
 */
const getUserFromRequest = req => {
  if (req.headers['authorization']) {
    const [type, value] = req.headers['authorization'].split(' ')

    if (type.toLowerCase() === 'basic' && value) {
      const [user, ...parts] = Buffer.from(value, 'base64')
        .toString()
        .split(':')
      return parts.length === 1 ? user : undefined
    }
  }
}

/**
 * If the client is behind a proxy, the x-forwarded-for header needs to be evaluated. Falls back to req.ip or 'unknown'.
 * - x-forwarded-for syntax: "<client>, <proxy1>, <proxy2>, ..."
 * - req.ip: "{left-most entry in the X-Forwarded-* header} || req.connection.remoteAddress" depending on express' trust proxy setting
 * @param {object} req - the request object
 * @returns {string} - the client ip as string
 * @private
 */
const getIpFromRequest = req => {
  const xForwardedFor = req.headers['x-forwarded-for']
  if (xForwardedFor) {
    return xForwardedFor.split(',')[0].trim()
  }

  return req.ip || 'unknown'
}

module.exports = { getIpFromRequest, getUserFromRequest }
