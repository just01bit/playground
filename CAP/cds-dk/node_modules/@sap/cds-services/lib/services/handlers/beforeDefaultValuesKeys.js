const { fillDataDeep } = require('../../util/dataProcessUtils')

const _addDefaultValuesAndKeys = async (context, model) => {
  const diff = await context.diff()
  fillDataDeep(model.definitions, context.data, context.target, diff, context.event, context.user)
  // TODO: remove this workaround
  const descriptor = Object.getOwnPropertyDescriptor(context, 'query')
  const isGetter = descriptor && descriptor.get && typeof descriptor.get === 'function'
  context && !isGetter && context._recalcQuery && context._recalcQuery()
}

/**
 * Generic handler for adding default keys and values
 *
 * @alias module:handlers.beforeDefaultValuesKeys
 */
const beforeDefaultValuesKeys = ({ model } = {}) => context => {
  if (context.target) {
    return _addDefaultValuesAndKeys(context, model)
  }
}

module.exports = beforeDefaultValuesKeys
