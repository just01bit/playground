const { normalizeError } = require('../../../util/errors')

/*
 * severities:
 *   1: success
 *   2: info
 *   3: warning
 *   4: error
 */
const DEFAULT_SEVERITY = 2

const _ensureSeverity = arg => {
  if (typeof arg === 'number' && arg > 0 && arg < 5) {
    return arg
  }

  return DEFAULT_SEVERITY
}

const _normalizeInfo = info => {
  const message = normalizeError(info)

  message.numericSeverity = _ensureSeverity(info && info.numericSeverity)

  if (info && info.longtextUrl && typeof info.longtextUrl === 'string') {
    message.longtextUrl = info.longtextUrl
  }

  return message
}

const setSapMessageHeader = (res, infos) => {
  if (infos) {
    res.setHeader('sap-messages', JSON.stringify(infos.map(_normalizeInfo)))
  }
}

module.exports = setSapMessageHeader
