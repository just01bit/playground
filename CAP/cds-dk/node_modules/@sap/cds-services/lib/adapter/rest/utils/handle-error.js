const { EOL } = require('os')
const { normalizeError } = require('../../../util/errors')

const _prepareErrorForLogging = err => {
  return `${err.statusCode ? `${err.statusCode} ` : ''}${err.message}${
    err.details ? `${EOL}Details:${err.details.map(detail => `${EOL}${detail.message}`)}` : ''
  }${err.stack ? `${EOL}${err.stack}` : ''}`
}

module.exports = (err, service, res) => {
  if (err.statusCode > 399 && err.statusCode < 500) {
    service.logger.warn(_prepareErrorForLogging(err))
  } else if (!err.statusCode || (err.statusCode > 499 && err.statusCode < 600)) {
    service.logger.error(_prepareErrorForLogging(err))

    if (process.env.NODE_ENV === 'production' && (!err.statusCode || err.statusCode === 500)) {
      err.message = 'Internal Server Error'
    }
  }

  const error = normalizeError(err)

  // FIXME: tests (rest-client.js) expect error.code = `${err.statusCode}` -> correct?
  error.code = `${err.statusCode || 500}`

  res.status(err.statusCode || 500).send({ error })
}
